<!DOCTYPE html>
<html>
<head>
    <title>Stock Inventory</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
</head>
<body>
<div class="container mt-4">
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="alert alert-{{ category }}">{{ message }}</div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    {% if login_page %}
    <!-- Login Page -->
    <div class="row justify-content-center">
        <div class="col-md-4">
            <h3>Login</h3>
            <form method="POST" action="{{ url_for('login') }}">
                <div class="mb-3">
                    <input type="text" name="username" class="form-control" placeholder="Username" required>
                </div>
                <div class="mb-3">
                    <input type="password" name="password" class="form-control" placeholder="Password" required>
                </div>
                <button type="submit" class="btn btn-primary">Login</button>
            </form>
        </div>
    </div>
    {% else %}
    <h3>Welcome {{ user.username }} ({{ user.role }})</h3>
    <a href="{{ url_for('logout') }}" class="btn btn-danger mb-3">Logout</a>

    {% if user.role == 'HOD' %}
    <!-- HOD Dashboard -->
    <h4>Stock Inventory</h4>
    <table class="table table-bordered">
        <thead>
            <tr><th>Name</th><th>Qty</th><th>Description</th><th>Location</th><th>Actions</th></tr>
        </thead>
        <tbody>
        {% for stock in stocks %}
            <tr>
                <td>{{ stock.name }}</td>
                <td>{{ stock.quantity }}</td>
                <td>{{ stock.description }}</td>
                <td>{{ stock.location }}</td>
                <td>
                    <form method="POST" action="{{ url_for('delete_stock', stock_id=stock.id) }}" style="display:inline">
                        <button class="btn btn-sm btn-danger">Delete</button>
                    </form>
                </td>
            </tr>
        {% endfor %}
        </tbody>
    </table>
    <h5>Add Stock</h5>
    <form method="POST" action="{{ url_for('add_stock') }}">
        <input type="text" name="name" placeholder="Item Name" required>
        <input type="number" name="quantity" placeholder="Quantity" required>
        <input type="text" name="description" placeholder="Description">
        <input type="text" name="location" placeholder="Location">
        <button class="btn btn-primary btn-sm">Add</button>
    </form>

    <h4>Requests</h4>
    <table class="table table-bordered">
        <thead>
            <tr><th>Engineer</th><th>Stock</th><th>Qty</th><th>Status</th><th>Courier</th><th>Actions</th></tr>
        </thead>
        <tbody>
        {% for req in requests %}
            <tr>
                <td>{{ req.engineer_id }}</td>
                <td>{{ req.stock.name }}</td>
                <td>{{ req.quantity }}</td>
                <td>{{ req.status }}</td>
                <td>{{ req.courier_docket or '' }}</td>
                <td>
                    {% if req.status == 'Pending' %}
                    <form method="POST" action="{{ url_for('process_request', req_id=req.id) }}">
                        <input type="text" name="courier_docket" placeholder="Courier Docket">
                        <button name="action" value="Approve" class="btn btn-sm btn-success">Approve</button>
                        <button name="action" value="Reject" class="btn btn-sm btn-danger">Reject</button>
                    </form>
                    {% endif %}
                </td>
            </tr>
        {% endfor %}
        </tbody>
    </table>

    <h4>Operation Logs</h4>
    <table class="table table-bordered">
        <thead>
            <tr><th>Timestamp</th><th>User</th><th>Action</th><th>Stock</th><th>Qty</th><th>Location</th><th>Courier</th></tr>
        </thead>
        <tbody>
        {% for log in logs %}
            <tr>
                <td>{{ log.timestamp }}</td>
                <td>{{ log.user }}</td>
                <td>{{ log.action }}</td>
                <td>{{ log.stock_name or '' }}</td>
                <td>{{ log.quantity or '' }}</td>
                <td>{{ log.location or '' }}</td>
                <td>{{ log.courier_docket or '' }}</td>
            </tr>
        {% endfor %}
        </tbody>
    </table>

    {% else %}
    <!-- Engineer Dashboard -->
    <h4>Available Stock</h4>
    <table class="table table-bordered">
        <thead>
            <tr><th>Name</th><th>Qty</th><th>Description</th><th>Location</th><th>Request</th></tr>
        </thead>
        <tbody>
        {% for stock in stocks %}
            <tr>
                <td>{{ stock.name }}</td>
                <td>{{ stock.quantity }}</td>
                <td>{{ stock.description }}</td>
                <td>{{ stock.location }}</td>
                <td>
                    <form method="POST" action="{{ url_for('request_stock', stock_id=stock.id) }}">
                        <input type="number" name="quantity" placeholder="Qty" min="1" max="{{ stock.quantity }}" required>
                        <button class="btn btn-sm btn-primary">Request</button>
                    </form>
                </td>
            </tr>
        {% endfor %}
        </tbody>
    </table>

    <h4>My Requests</h4>
    <table class="table table-bordered">
        <thead>
            <tr><th>Stock</th><th>Qty</th><th>Status</th><th>Courier Docket</th><th>Timestamp</th></tr>
        </thead>
        <tbody>
        {% for req in requests %}
            <tr>
                <td>{{ req.stock.name }}</td>
                <td>{{ req.quantity }}</td>
                <td>{{ req.status }}</td>
                <td>{{ req.courier_docket or '' }}</td>
                <td>{{ req.timestamp }}</td>
            </tr>
        {% endfor %}
        </tbody>
    </table>
    {% endif %}
    {% endif %}
</div>
</body>
</html>
