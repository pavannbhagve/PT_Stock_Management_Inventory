<!-- templates/main.html -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PT ESPL - Stock Inventory</title>
  <style>
    /* Page layout and styling inspired by provided screenshots */
    :root{
      --nav-bg:#1f2937;
      --accent: #6f42c1;
      --card-bg: #ffffff;
      --muted:#6b7280;
      --success:#10b981;
      --danger:#ef4444;
      --shadow: 0 10px 25px rgba(15,23,42,0.08);
    }
    body{font-family: "Segoe UI", Roboto, Arial, sans-serif;margin:0;background:#f3f4f6;color:#111}
    .topnav{background:var(--nav-bg);padding:12px 16px;display:flex;gap:12px;align-items:center;box-shadow:0 2px 6px rgba(0,0,0,0.12)}
    .nav-item{color:#fff;padding:10px 12px;border-radius:6px;text-decoration:none;font-weight:600;font-size:14px}
    .nav-item:hover{background:rgba(255,255,255,0.04)}
    .container{max-width:1100px;margin:20px auto;padding:12px}
    h1{font-size:26px;text-align:center;margin:12px 0}
    .grid{display:grid;grid-template-columns:1fr;gap:18px}
    .card{background:var(--card-bg);border-radius:10px;padding:18px;box-shadow:var(--shadow);overflow:hidden}
    .section-title{font-weight:700;margin-bottom:8px;color:#111}
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{padding:10px;border-bottom:1px solid #eef2f7;text-align:left;font-size:14px}
    .table th{background:#f8fafc;font-weight:700;color:#374151}
    label{display:block;font-size:13px;margin-top:8px;color:#374151}
    input[type=text], input[type=number], select, textarea{padding:9px;border-radius:8px;border:1px solid #e6eef6;width:100%;box-sizing:border-box;font-size:14px}
    .row{display:flex;gap:12px;align-items:center}
    .btn{background:var(--accent);color:#fff;padding:9px 12px;border-radius:8px;border:none;cursor:pointer;font-weight:700}
    .btn.red{background:var(--danger)}
    .btn.ghost{background:transparent;border:1px solid #e6eef6;color:#111}
    .muted{color:var(--muted);font-size:13px}
    .small{font-size:12px;color:#6b7280}
    .success{color:var(--success);font-weight:700}
    .danger{color:var(--danger);font-weight:700}
    .top-row{display:flex;justify-content:space-between;align-items:center;gap:12px}
    .badge{background:#f1f5f9;padding:6px 10px;border-radius:999px;font-weight:700;color:#0f172a}
    .form-inline{display:flex;gap:8px;align-items:center}
    .form-inline input, .form-inline select{width:auto}
    .center{display:flex;justify-content:center;align-items:center}
    .timestamp{font-size:12px;color:#9ca3af}
    .actions form{display:inline-block;margin:0}
    /* gentle colors for blocks like screenshots */
    .block-green{background:#ecfdf5}
    .block-yellow{background:#fffbeb}
    .block-blue{background:#eff6ff}
    .block-pink{background:#fff1f2}
    .block-lilac{background:#faf5ff}
    /* responsive */
    @media (max-width:900px){
      .row{flex-direction:column;align-items:stretch}
      .top-row{flex-direction:column;align-items:flex-start}
    }
  </style>
</head>
<body>
  <div class="topnav">
    <a class="nav-item" href="{{ url_for('engineer_dashboard') }}">Available Stock</a>
    <a class="nav-item" href="{{ url_for('engineer_dashboard') }}">Stock Requests</a>
    <a class="nav-item" href="{{ url_for('engineer_dashboard') }}">Urgent Request</a>
    <a class="nav-item" href="{{ url_for('engineer_dashboard') }}">My Stock</a>
    <a class="nav-item" href="{{ url_for('engineer_dashboard') }}">Stock Usage</a>
    {% if session.get('user_id') %}
      <div style="margin-left:auto;color:#fff;font-weight:700">Hi, {{ session.get('username') }}</div>
      <a class="nav-item" style="margin-left:10px" href="{{ url_for('logout') }}">Logout</a>
    {% endif %}
  </div>

  <div class="container">
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, msg in messages %}
          <div style="margin-bottom:12px;padding:10px;border-radius:8px;background:#f0fdf4;color:#065f46">{{ msg }}</div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    {# LOGIN #}
    {% if not session.get('user_id') %}
      <div class="card center" style="max-width:480px;margin:60px auto;flex-direction:column;">
        <h2>Login</h2>
        <form method="post" action="{{ url_for('login') }}" style="width:100%;">
          <label>Username</label>
          <input type="text" name="username" required>
          <label>Password</label>
          <input type="password" name="password" required>
          <div style="margin-top:12px" class="center">
            <button class="btn" type="submit">Login</button>
          </div>
        </form>
        <p class="small" style="margin-top:10px">HOD default: <b>PTESPL</b> / <b>ptespl@123</b></p>
      </div>
    {% endif %}

    {# ENGINEER DASHBOARD #}
    {% if engineer %}
      <h1>Engineer Dashboard</h1>
      <div class="grid">
        <div class="card block-green">
          <div class="top-row">
            <div>
              <div class="section-title">Available Main Stock</div>
              <div class="small muted">Stock maintained by HOD</div>
            </div>
            <div class="badge">As of server time</div>
          </div>
          <table class="table" style="margin-top:12px">
            <thead>
              <tr><th>STOCK NAME</th><th>QUANTITY</th></tr>
            </thead>
            <tbody>
              {% for s in stocks %}
                <tr><td>{{ s.name }}</td><td>{{ s.quantity }}</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <div class="card block-yellow">
          <div class="section-title">Stock Requests</div>
          <form method="post" action="{{ url_for('api_create_request') }}">
            <div class="row" style="align-items:center;">
              <div style="flex:1">
                <label>Stock Name</label>
                <input id="stock_search" placeholder="type to filter or leave blank for urgent">
                <select id="stock_select" name="stock_id" style="margin-top:8px">
                  <option value="">-- Choose stock (or leave blank for urgent) --</option>
                  {% for s in stocks %}
                    <option value="{{ s.id }}" data-name="{{ s.name }}">{{ s.name }} ({{ s.quantity }})</option>
                  {% endfor %}
                </select>
              </div>
              <div style="width:120px">
                <label>Quantity</label>
                <input type="number" name="quantity" value="1" min="1">
              </div>
              <div style="flex:1">
                <label>Remarks</label>
                <input type="text" name="remarks" placeholder="optional remark">
              </div>
              <div style="width:140px;align-self:flex-end">
                <button class="btn" type="submit">Send Request</button>
              </div>
            </div>
            <div style="margin-top:8px">
              <label>Urgent / Emergency stock name (if not present above)</label>
              <input type="text" name="emergency_text" placeholder="Urgent stock name (optional)">
            </div>
          </form>

          <table class="table" style="margin-top:12px">
            <thead><tr><th>STOCK NAME</th><th>QUANTITY</th><th>REMARKS</th><th>STATUS</th><th>DOCKET</th><th>TIMESTAMP</th><th>ACTIONS</th></tr></thead>
            <tbody>
              {% for r in my_requests %}
                <tr>
                  <td>{% if r.stock %}{{ r.stock.name }}{% else %}EMER: {{ r.emergency_text }}{% endif %}</td>
                  <td>{{ r.quantity }}</td>
                  <td class="small">{{ r.hod_comment or '-' }}</td>
                  <td>
                    {% if r.status == 'pending' %}<span class="small">Pending</span>
                    {% elif r.status == 'approved' %}<span class="small success">Approved</span>
                    {% elif r.status == 'in_transit' %}<span class="small">In Transit</span>
                    {% elif r.status == 'received' %}<span class="small success">Received</span>
                    {% elif r.status == 'denied' %}<span class="small danger">Denied</span>
                    {% endif %}
                  </td>
                  <td>{{ r.docket_number or '-' }}</td>
                  <td class="timestamp">{{ r.updated_at.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                  <td class="actions">
                    {% if r.status == 'in_transit' %}
                      <form method="post" action="{{ url_for('api_mark_received', request_id=r.id) }}">
                        <button class="btn" type="submit">Mark as Received</button>
                      </form>
                    {% elif r.status in ['pending','denied'] %}
                      <form method="post" action="{{ url_for('api_cancel_request', request_id=r.id) }}" onsubmit="return confirm('Delete request?');">
                        <button class="btn red" type="submit">Delete</button>
                      </form>
                    {% else %}
                      <span class="small muted">No action</span>
                    {% endif %}
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <div class="card block-pink">
          <div class="section-title">Urgent Stock Request</div>
          <form method="post" action="{{ url_for('api_create_request') }}">
            <div class="row">
              <div style="flex:1">
                <label>Stock Name</label>
                <input type="text" name="emergency_text" placeholder="Urgent stock name">
              </div>
              <div style="width:120px">
                <label>Quantity</label>
                <input type="number" name="quantity" value="1" min="1">
              </div>
              <div style="width:140px;align-self:flex-end">
                <button class="btn red" type="submit">Send Urgent Request</button>
              </div>
            </div>
          </form>
        </div>

        <div class="card block-blue">
          <div class="section-title">My Personal Stock</div>
          <form method="post" action="{{ url_for('api_engineer_stock_add') }}" class="form-inline">
            <input type="text" name="stock_name" placeholder="Stock Name">
            <input type="number" name="quantity" placeholder="Quantity" style="width:120px">
            <button class="btn" type="submit">Add/Update Stock</button>
          </form>

          <table class="table" style="margin-top:12px">
            <thead><tr><th>STOCK NAME</th><th>QUANTITY</th><th>TIMESTAMP</th><th>ACTIONS</th></tr></thead>
            <tbody>
              {% for es in my_engineer_stocks %}
                <tr>
                  <td>{{ es.stock.name }}</td>
                  <td>{{ es.quantity }}</td>
                  <td class="timestamp">{{ es.updated_at.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                  <td>
                    <form method="post" action="{{ url_for('api_issue_add') }}">
                      <input type="hidden" name="stock_id" value="{{ es.stock.id }}">
                      <input type="number" name="quantity" value="1" min="1" style="width:80px">
                      <input type="text" name="site_name" placeholder="Site" style="width:140px">
                      <button class="btn" type="submit">Issue</button>
                    </form>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <div class="card block-lilac">
          <div class="section-title">Stock Usage</div>
          <table class="table">
            <thead><tr><th>STOCK NAME</th><th>QUANTITY USED</th><th>SITE NAME</th><th>REASON</th><th>TIMESTAMP</th></tr></thead>
            <tbody>
              {% for it in my_issues %}
                <tr>
                  <td>{{ it.stock.name }}</td>
                  <td>{{ it.quantity }}</td>
                  <td>{{ it.site_name }}</td>
                  <td class="small">{{ it.reason }}</td>
                  <td class="timestamp">{{ it.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    {% endif %}

    {# HOD DASHBOARD #}
    {% if hod %}
      <h1>HOD Dashboard</h1>
      <div class="grid">
        <div class="card block-yellow">
          <div class="section-title">Stock Requests</div>
          <table class="table">
            <thead><tr><th>STOCK NAME</th><th>QTY</th><th>REQUESTED BY</th><th>REMARKS</th><th>STATUS</th><th>TIMESTAMP</th><th>ACTIONS</th></tr></thead>
            <tbody>
              {% for r in requests %}
                <tr>
                  <td>{% if r.stock %}{{ r.stock.name }}{% else %}EMER: {{ r.emergency_text }}{% endif %}</td>
                  <td>{{ r.quantity }}</td>
                  <td>{{ r.engineer.username }}</td>
                  <td class="small">{{ r.hod_comment or '-' }}</td>
                  <td>
                    {% if r.status == 'pending' %}<span class="small">Pending</span>
                    {% elif r.status == 'approved' %}<span class="small success">Approved</span>
                    {% elif r.status == 'in_transit' %}<span class="small">In Transit</span>
                    {% elif r.status == 'received' %}<span class="small success">Received</span>
                    {% elif r.status == 'denied' %}<span class="small danger">Denied</span>
                    {% endif %}
                  </td>
                  <td class="timestamp">{{ r.updated_at.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                  <td class="actions">
                    {% if r.status == 'pending' %}
                      <form method="post" action="{{ url_for('api_request_act', request_id=r.id) }}" style="display:inline-block">
                        <input type="hidden" name="action" value="approve">
                        <input type="text" name="comment" placeholder="Comment">
                        <button class="btn" type="submit">Approve</button>
                      </form>
                      <form method="post" action="{{ url_for('api_request_act', request_id=r.id) }}" style="display:inline-block">
                        <input type="hidden" name="action" value="deny">
                        <input type="text" name="comment" placeholder="Reason">
                        <button class="btn red" type="submit">Deny</button>
                      </form>
                    {% elif r.status == 'approved' %}
                      <form method="post" action="{{ url_for('api_request_act', request_id=r.id) }}">
                        <input type="hidden" name="action" value="dispatch">
                        <input type="text" name="docket" placeholder="Docket number" required>
                        <button class="btn" type="submit">Dispatch</button>
                      </form>
                    {% elif r.status == 'in_transit' %}
                      <div class="small">In transit - Docket: <b>{{ r.docket_number }}</b></div>
                    {% else %}
                      <div class="small muted">No action</div>
                    {% endif %}
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <div class="card block-blue">
          <div class="section-title">Stock Management</div>
          <form method="post" action="{{ url_for('api_add_stock') }}" class="form-inline">
            <input type="text" name="name" placeholder="Stock Name">
            <input type="number" name="quantity" placeholder="Quantity" style="width:120px">
            <button class="btn" type="submit">Add Stock</button>
          </form>

          <table class="table" style="margin-top:12px">
            <thead><tr><th>STOCK NAME</th><th>QUANTITY</th><th>TIMESTAMP</th><th>ACTIONS</th></tr></thead>
            <tbody>
              {% for s in stocks %}
                <tr>
                  <td>{{ s.name }}</td>
                  <td>{{ s.quantity }}</td>
                  <td class="timestamp">{{ s.updated_at.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                  <td>
                    <form method="post" action="{{ url_for('api_edit_stock', stock_id=s.id) }}" style="display:inline-block">
                      <input type="text" name="name" placeholder="name">
                      <input type="number" name="quantity" placeholder="qty" style="width:90px">
                      <button class="btn" type="submit">Edit</button>
                    </form>
                    <form method="post" action="{{ url_for('api_delete_stock', stock_id=s.id) }}" style="display:inline-block" onsubmit="return confirm('Delete stock?');">
                      <button class="btn red" type="submit">Delete</button>
                    </form>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <div class="card" style="background:#e6eef6">
          <div class="section-title">Manage Engineers</div>
          <form method="post" action="{{ url_for('api_add_engineer') }}" class="form-inline">
            <input type="text" name="username" placeholder="Username">
            <input type="text" name="password" placeholder="Password">
            <input type="text" name="full_name" placeholder="Full name">
            <button class="btn" type="submit">Add Engineer</button>
          </form>

          <table class="table" style="margin-top:12px">
            <thead><tr><th>USERNAME</th><th>FULL NAME</th><th>TIMESTAMP</th><th>ACTIONS</th></tr></thead>
            <tbody>
              {% for e in engineers %}
                <tr>
                  <td>{{ e.username }}</td>
                  <td>{{ e.full_name }}</td>
                  <td class="timestamp">{{ e.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                  <td>
                    <form method="post" action="{{ url_for('api_delete_engineer', user_id=e.id) }}" onsubmit="return confirm('Delete engineer?');">
                      <button class="btn red" type="submit">Delete</button>
                    </form>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <div class="card block-green">
          <div class="section-title">Engineer Personal Stock</div>
          <table class="table">
            <thead><tr><th>ENGINEER</th><th>STOCK NAME</th><th>QUANTITY</th><th>TIMESTAMP</th></tr></thead>
            <tbody>
              {% for es in engineer_stocks %}
                <tr>
                  <td>{{ es.engineer.username }}</td>
                  <td>{{ es.stock.name }}</td>
                  <td>{{ es.quantity }}</td>
                  <td class="timestamp">{{ es.updated_at.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <div class="card block-lilac">
          <div class="section-title">Stock Usage Log</div>
          <table class="table">
            <thead><tr><th>ENGINEER</th><th>STOCK NAME</th><th>QUANTITY</th><th>SITE</th><th>REASON</th><th>TIMESTAMP</th></tr></thead>
            <tbody>
              {% for it in issues %}
                <tr>
                  <td>{{ it.engineer.username }}</td>
                  <td>{{ it.stock.name }}</td>
                  <td>{{ it.quantity }}</td>
                  <td>{{ it.site_name }}</td>
                  <td class="small">{{ it.reason }}</td>
                  <td class="timestamp">{{ it.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    {% endif %}
  </div>

  <script>
    // Type-to-filter for stock dropdown (engineer)
    const stockSearch = document.getElementById('stock_search');
    const stockSelect = document.getElementById('stock_select');
    if(stockSearch && stockSelect){
      stockSearch.addEventListener('input', function(e){
        const q = e.target.value.toLowerCase();
        for(let i=0;i<stockSelect.options.length;i++){
          const opt = stockSelect.options[i];
          const name = (opt.dataset.name || opt.text).toLowerCase();
          opt.style.display = name.indexOf(q) !== -1 ? '' : 'none';
        }
      });
    }
  </script>
</body>
</html>
